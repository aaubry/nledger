<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

   <!-- Upgrade code for all NLedger versions. Must be the same for all updates. -->
   <?define UpgradeCode="20E40538-6702-4A39-9901-1EC041653F73" ?>

   <!-- Product version - takes from exe file (four number file version) -->
   <?define VersionNumber="!(bind.FileVersion.File_NLedger_cli_exe)" ?>

   <!-- Help URL (used in Add/Remove programs) -->
   <?define InfoURL="https://github.com/dmitry-merzlyakov/nledger" ?>


   <!-- Product IDs must be autogenerated (*) in order to make major upgrades pass well -->
   <Product Id="*" UpgradeCode="$(var.UpgradeCode)" Name="!(loc.Product_Name)" Version="$(var.VersionNumber)" Manufacturer="!(loc.Product_Manufacturer)" Language="!(loc.Language)">
      <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Description="!(loc.Product_Description)" Comments="!(loc.Package_Comments) $(var.VersionNumber)" />
      <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

      <!-- Checking required .Net Framework version -->

      <Property Id="WIX_IS_NETFRAMEWORK_472_OR_LATER_INSTALLED">
         <RegistrySearch Id="NET472Installed" Root="HKLM" Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" Name="Release" Type="raw" />
      </Property>

      <Condition Message="!(loc.Condition_NetFrameworkIsNotInstalled)">
         <![CDATA[Installed OR WIX_IS_NETFRAMEWORK_472_OR_LATER_INSTALLED]]>
      </Condition>

      <!-- VBS custom actions  -->

      <Binary Id='InstallerScripts' SourceFile='InstallerScripts.vbs' />

      <!-- Checks installed Powershell version (4 or higher) -->

      <!-- Table of conditions - https://stackoverflow.com/questions/320921/how-to-add-a-wix-custom-action-that-happens-only-on-uninstall-via-msi -->
      <InstallExecuteSequence> 
         <Custom Action="GetPowershellVersion" Before ="InstallFiles">(NOT REMOVE) OR UPGRADINGPRODUCTCODE</Custom>  
         <Custom Action="ShowNoPowershellWarningMessage" Before ="InstallFiles">(PSVERSIONMAJOR &lt; 4) AND ((NOT REMOVE) OR UPGRADINGPRODUCTCODE) AND PowershellIsRequired</Custom>  
      </InstallExecuteSequence> 
      <SetProperty Id="NoPowershellWarningMessage" Value="!(loc.Condition_PowershellIsNotInstalled)" After="CostFinalize" />
      <SetProperty Id="PowershellIsRequired" Value="1" After="CostFinalize" >((&amp;SetupConsoleFeature=3) AND NOT(!SetupConsoleFeature=3)) OR ((&amp;LiveDemoFeature=3) AND NOT(!LiveDemoFeature=3)) OR ((&amp;TestToolkitFeature=3) AND NOT(!TestToolkitFeature=3)) OR ((&amp;ManualInstallFeature=3) AND NOT(!ManualInstallFeature=3))</SetProperty>
      <CustomAction Id='ShowNoPowershellWarningMessage' BinaryKey='InstallerScripts' VBScriptCall='ShowNoPowershellWarningMessage' />
      <CustomAction Id='GetPowershellVersion' BinaryKey='InstallerScripts' VBScriptCall='GetPowershellVersion' />
      
      <!-- Deletes user settings on uninstalling with user's confirmation -->

      <InstallExecuteSequence> 
         <Custom Action="DeleteUserSettings" After="InstallFinalize">(NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>  
      </InstallExecuteSequence> 
      <SetProperty Id="DeleteUserSettingsQuestionText" Value="!(loc.Condition_DeleteUserSettings)" After="CostFinalize" />
      <CustomAction Id='DeleteUserSettings' BinaryKey='InstallerScripts' VBScriptCall='DeleteUserSettings' />

      <!-- UI Customization -->

      <WixVariable Id="WixUILicenseRtf" Value="$(var.PackageFolder)NLedger\LICENSE.rtf" />
      <!-- Extra messages on Exit dialog -->
      <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="!(loc.ExitDialog_WelcomeText)" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="!(loc.ExitDialog_LaunchText)" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
      <Property Id="WixShellExecTarget" Value="none" />
      <SetProperty Id="WixShellExecTarget" Value="[APPLICATIONFOLDER]README.html" After="CostFinalize" />
      <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

      <!-- Images -->

      <WixVariable Id="WixUIBannerBmp" Value="Images\WixUIBanner.jpg" />
      <WixVariable Id="WixUIDialogBmp" Value="Images\WixUIDialog.jpg" />
      <Icon Id="Icon.exe" SourceFile="Images\WixUIIcon.ico" /> 
      <Property Id="ARPPRODUCTICON" Value="Icon.exe" />

      <!-- Upgrade definition -->

      <MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" Schedule="afterInstallExecute" />

      <Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
 
      <!-- Dealing with files -->

      <Directory Id="TARGETDIR" Name="SourceDir">

         <!-- Shortcuts -->

         <Directory Id="ProgramMenuFolder">
            <Directory Id="ProgramMenuSubfolder" Name=".Net Ledger">
               <Component Id="ProgramMenuSubfolderShortcuts" Guid="F74D2881-317F-4559-97BF-29C23CBD4785" >
                  <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall"/>
                  <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\ProgramMenuSubfolderShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
               </Component>
               <Component Id="NLedgerFolderShortcuts" Guid="C14A9C6D-27EE-4DDB-BA13-D9E2BE4CFF36" >
                  <Shortcut Id="NLedgerFolderShortcut" Name=".Net Ledger Folder" Description="Ledger Application Folder" Target="[APPLICATIONFOLDER]" WorkingDirectory="APPLICATIONFOLDER"/>
                  <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLedgerFolderShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
               </Component>
               <Component Id="NLedgerToolsShortcuts" Guid="1CF76353-E025-4F34-8EBE-53332CA0B42B" >
                  <Shortcut Id="NLManagementSetupShortcut" Name=".Net Ledger Tools" Description=".Net Ledger Tools Console" Target="[APPLICATIONFOLDER]\nledger-tools.cmd" Icon="Icon.exe" WorkingDirectory="APPLICATIONFOLDER"/>
                  <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLedgerToolsShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
               </Component>
               <Component Id="LedgerDocShortcuts" Guid="145D5737-73E5-42D3-A292-8C1643A5B630" >
                  <Shortcut Id="LedgerDocShortcutLedger3Html" Name="Ledger 3 Documentation" Description="Ledger: Command-Line Accounting" Target="[APPLICATIONFOLDER]ledger3.html" WorkingDirectory="APPLICATIONFOLDER"/>
                  <Shortcut Id="LedgerDocShortcutLedger3Man" Name="Ledger 3 Man Page" Description="Man page of LEDGER" Target="[APPLICATIONFOLDER]ledger.1.html" WorkingDirectory="APPLICATIONFOLDER"/>
                  <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\LedgerDocShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
               </Component>
               <Component Id="NLedgerDocShortcuts" Guid="1442D7CB-462F-47A1-91FA-76AE386B13E2" >
                  <Shortcut Id="NLedgerDocShortcutNLedgerHtml" Name=".Net Ledger Guide" Description=".Net Ledger Documentation" Target="[APPLICATIONFOLDER]nledger.html" WorkingDirectory="APPLICATIONFOLDER"/>
                  <Shortcut Id="NLedgerDocShortcutREADMEHtml" Name=".Net Ledger Readme" Description=".Net Ledger Release Notes" Target="[APPLICATIONFOLDER]README.html" WorkingDirectory="APPLICATIONFOLDER"/>
                  <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLedgerDocShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
               </Component>
            </Directory>
         </Directory>

      </Directory>

      <!-- Feature definitions -->

      <Feature Id="NLedgerFeature" Title="!(loc.NLedgerFeature_Title)" Level="1" Display="expand" Description="!(loc.NLedgerFeature_Desc)" ConfigurableDirectory="APPLICATIONFOLDER" AllowAdvertise="no" Absent="disallow" InstallDefault="local" >

         <!-- NLedger Core components (not optional) -->
         <ComponentRef Id="BinNetStandard20Files"/>            <!-- NLedger dll and exe files -->
         <ComponentRef Id="BinNet48Files"/>                    <!-- NLedger dll and exe files -->
         <ComponentRef Id="BinNet60Files"/>                    <!-- NLedger dll and exe files -->
         <ComponentRef Id="BinNet80Files"/>                    <!-- NLedger dll and exe files -->
         <ComponentRef Id="CommonFiles"/>                      <!-- NLedger Powershell tool files -->
         <ComponentRef Id="Extras"/>                           <!-- Extras folder with samples for db calls -->
         <ComponentRef Id="NLedgerToolsFiles"/>                <!-- NLedger Powershell tool console -->
         <ComponentRef Id="LicenseFiles"/>                     <!-- License files -->
         <ComponentRef Id="LedgerManFiles"/>                   <!-- Ledger manual file -->
         <ComponentRef Id="NLedgerReleaseNotesFiles"/>         <!-- Release Notes (readme and changelog) that are open after install -->
         <ComponentRef Id="NLedgerFolderShortcuts"/>           <!-- Adding a shortcut for NLedger folder -->
         <ComponentRef Id="ProgramMenuSubfolderShortcuts"/>    <!-- Common component to manage main menu folder with shortcuts -->
         <ComponentRef Id="LedgerSharedTestFiles_input"/>      <!-- Example data files -->

         <Feature Id="DocFilesFeature" Title="!(loc.DocFilesFeature_Title)" Level="1" Description="!(loc.DocFilesFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="LedgerDocFiles"/>                 <!-- Ledger 3 Documentation -->
           <ComponentRef Id="NLedgerDocFiles"/>                <!-- NLedger short doc -->
           <ComponentRef Id="LedgerDocShortcuts"/>             <!-- Shortcuts -->
           <ComponentRef Id="NLedgerDocShortcuts"/>
         </Feature>

         <Feature Id="LiveDemoFeature" Title="!(loc.LiveDemoFeature_Title)" Level="1" Description="!(loc.LiveDemoFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="LiveDemoFiles"/>
           <ComponentRef Id="SandboxTestFiles"/>
         </Feature>

         <!-- Python extension is disabled by default -->
         <Feature Id="PythonExtensionFeature" Title="!(loc.PythonExtensionFeature_Title)" Level="5" Description="!(loc.PythonExtensionFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="PythonContrib"/>
         </Feature>

         <!-- Test toolkit is disabled by default -->
         <Feature Id="TestToolkitFeature" Title="!(loc.TestToolkitFeature_Title)" Level="5" Description="!(loc.TestToolkitFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="LedgerTestFiles_manual"/>
           <ComponentRef Id="LedgerTestFiles_nledger"/>
           <ComponentRef Id="LedgerTestFiles_input"/>
           <ComponentRef Id="LedgerTestFiles_baseline"/>
           <ComponentRef Id="LedgerTestFiles_regress"/>
           <ComponentRef Id="NLedgerTestToolkit"/>
         </Feature>

      </Feature>

      <UI>
	      <UIRef Id="WixUI_Mondo"/>
         <!-- Exit dialog action (show readme) -->
         <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
      </UI>

      <!-- Run PS installing scripts -->

      <SetProperty Id="AppBinInstall"   Value='"[SystemFolder]cmd.exe" /C PowerShell -NoLogo -NoExit -ExecutionPolicy RemoteSigned -File "[APPLICATIONFOLDER]nledger-tools.ps1 install -link"' Sequence='execute' Before="AppBinInstall" />
      <SetProperty Id="AppBinUninstall" Value='"[SystemFolder]cmd.exe" /C PowerShell -NoLogo -NoExit -ExecutionPolicy RemoteSigned -File "[APPLICATIONFOLDER]nledger-tools.ps1 uninstall' Sequence='execute' Before="AppBinUninstall" />

      <CustomAction Id='AppBinInstall' BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Impersonate="no" Return="ignore" /> 
      <CustomAction Id='AppBinUninstall' BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Impersonate="no" Return="ignore" /> 

      <InstallExecuteSequence> 
         <Custom Action="AppBinInstall" Before="InstallFinalize">$NLedgerToolsFiles&gt;2</Custom>  
         <Custom Action="AppBinUninstall" Before="MsiUnpublishAssemblies">$NLedgerToolsFiles=2</Custom>  
      </InstallExecuteSequence>

   </Product>

</Wix>